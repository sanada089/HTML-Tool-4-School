<!doctype html>
<html lang="de">


<head>
  <title>HTML-Tool</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/main.css">

  <!-- Laden der benötigten Blockly-Module -->

  <script src="node_modules/blockly/blockly_compressed.js"></script>
  <script src="node_modules/blockly/blocks_compressed.js"></script>

  <!-- Laden der benötigten Blockly-Sprachfiles für deutsche Sprache -->

  <script src="node_modules/blockly/msg/de.js"></script>
  <!--
  <script>

    var popup;

    // When the user clicks on <div>, open the popup
    function myFunction() {
      popup = document.getElementById('myPopup');
      popup.classList.toggle('show');
    }

    // When the user clicks on <div>, open the popup
    function myFunction1() {
      popup = document.getElementById('myPopup1');
      popup.classList.toggle('show');
    }
  </script>
-->
</head>

<body>

<!-- Laden der benötigten Javascript-Files aus dem Unterverzeichnis js -->

<script src="js/html_blocks.js"></script>
<script src="js/html_generator.js"></script>
<script src="js/main.js"></script>

<!-- Leiste zur Auswahl von Leveln -->

<div id="LevelSelectionDiv">
  <!-- Button um zwischen Lern-Sektion und Bastel-Sektion hin und her zu wechseln -->
  <button class="levelButton" onclick="location.href='index.html'">Bastelecke</button>
  <button class="levelButton" onclick="location.href='hilfestellung.html'">Hilfestellung</button>
  <button class="switchButton" onclick=switchPreview()>Aufgabenstellung/<br> Vorschau</button>

</div>



<!-- Kompletter Mittelteil der Seite, der komplette grid mit zugehörigen divs -->

<div class="grid-container">

  <div class="item2">
    <div id="blocklyDiv"></div>
  </div>

  <!-- Hier wird der Preview iframe, der in der update-Funktion im Script-Block befüllt wird in die HTMLPageDiv geladen -->
  <div class="item3">
    <iframe name="preview" id="HTMLPageDiv"></iframe>
  </div>

  <div class="item4">
    <iframe name="codePreview" id="HTMLCodeDiv"></iframe>
  </div>

  <div class="item5">
    <div id="CodeButtonDiv">
      <button class="codeButton" onclick=showCode()>Code</button>
      <button class="codeButton" onclick=showGscheidhaferl()>Gscheidhaferl</button>
      <button class="codeButton" onclick=showHausl()>Hausl</button>
    </div>
  </div>
</div>

<!-- Popups, die leider nicht so wollten wie wir
<div class="popup" onclick="myFunction()">
  <img src="istockphoto-1014757370-612x612.jpg" style="width:100px;height:200px;">
  <span class="popuptext" id="myPopup">Hallo, ich bin Herr Hausl
  <audio id="audio_with_controls" controls>

    <source src="Hallo.ogg" type="audio/ogg"/>

</audio>
  </span>
</div>

<div class="popup" onclick="myFunction1()">
  <img src="istockphoto-834467010-612x612.jpg" style="width:200px;height:200px;">
  <span class="popuptext" id="myPopup1">Hallo, ich bin Frau Gscheidhaferl. <br><br> Wie kann ich dir helfen? <br><br>
    <button class="helpButton" onclick="window.open('HTMLHelp.html','_blank')">Was ist HTML?</button>
    <button class="helpButton">Was soll ich tun?</button> </span>
</div>
-->


<!-- Beginn Skript-Block -->

<script>

  // Einfügen des Blockly-Workspace mit zugehöriger Toolbox in die blocklyDiv
  const workspace = Blockly.inject('blocklyDiv', {toolbox: toolbox});

  //Laden des vorherigen Zustandes des workspace aus der localStorage des Browsers

  var xml_text = localStorage.getItem("blockly-html-code-learning");
  if (xml_text) {
    var xml = Blockly.Xml.textToDom(xml_text);
    Blockly.Xml.domToWorkspace(xml, workspace);
  }

  //Erstellung des Parameters html, der im IFrame ausgegeben wird (wird in update() und switchPreview() benötigt)
  var html;
  // previewFlag gibt an ob schon Blocks im workspace benutzt wurden
  var previewFlag;
  //previewCode ist die Vorschau der aktuell erwünschten Seite
  var previewCode;
  //code ist der aktuell aus den Blocks erzeugte Code
  var code;
  //codeFlag zeigt an, was gerade in der HTMLCodeDiv angezeigt werden soll
  var codeFlag

  //Setzen von previewCode anhand des aktuellen Lernstandes !!!TO DO!!!

  previewCode="<!DOCTYPE HTML>\n" +
    "<html>\n" +
    "<meta charset=\"utf-8\">\n" +
    "<head>\n" +
    "Testschnieselei\n" +
    "</head>\n" +
    "\n" +
    "</html>";

  // Update-Funktion, die aufgerufen wird, wenn sich im Workspace etwas ändert

  function update(event){

    // Umwandlung des workspace zu HTML-Code via HTMLGenerator
    code = HtmlGenerator.workspaceToCode(workspace);
    // Will der User gerade den Code sehen wird dieser aktualisiert in der HTMLCodeDiv
    if(!codeFlag || codeFlag ===0){
      showCode();
    }

    // Erstellung des IFrame aus dem erzeugten HTML-Code
    const ifr = document.preview;
    html = code;
    ifr.document.write(html);
    ifr.document.close();

    // Speichern des Zustandes des workspace in der localStorage des Browsers

    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToText(xml);
    localStorage.setItem("blockly-html-code-learning", xml_text);

  }


  //Aufruf der Updatefunktion, sobald eine Änderung im workspace passiert

  workspace.addChangeListener(update);

  //function, die den Code im IFrame zwischen der erwünschten Vorschau und dem Ist-Stand des Users wechselt

  function switchPreview(){
    if(!previewFlag || previewFlag===0) {
      html=previewCode;
      const previewIfr = document.preview;
      previewIfr.document.write(html);
      previewIfr.document.close();
      previewFlag=1;
    }
    else {
      update();
      previewFlag=0;
    }

  }
  //wird aufgerufen, wenn auf den Code-Knopf gedrückt wird. Zeigt dann den aktuellen aus Blocks erzeugten Code
  function showCode(){
    var htmlCode="<xmp>" + code + "</xmp>";
    const ifr = document.codePreview;
    ifr.document.write(htmlCode);
    ifr.document.close();

    codeFlag=0;
  }

  //wird aufgerufen, wenn auf den Gscheidhaferl-Knopf gedrückt wird. Zeigt dann die zum Level gehörige Gscheidhaferl-Page
  function showGscheidhaferl(){
    const ifr = document.codePreview;
    ifr.document.write(previewCode);
    ifr.document.close();
    codeFlag=1;
  }
  //wird aufgerufen, wenn auf den Hausl-Knopf gedrückt wird. Zeigt dann die zum Level gehörige Hausl-Page
  function showHausl(){
    const ifr = document.codePreview;
    ifr.document.write(previewCode);
    ifr.document.close();
    codeFlag=2;
  }

</script>


</body>

</html>
