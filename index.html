<!doctype html>
<html lang="de">


<head>
  <title>HTML-Tool</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/main.css">

  <!-- Laden der benötigten Blockly-Module -->
  <script src="node_modules/blockly/blockly_compressed.js"></script>
  <script src="node_modules/blockly/blocks_compressed.js"></script>

  <!-- Laden der benötigten Blockly-Sprachfiles für deutsche Sprache -->
  <script src="node_modules/blockly/msg/de.js"></script>

</head>

<body>

<!-- Laden der benötigten Javascript-Files aus dem Unterverzeichnis js -->

<script src="js/html_blocks.js"></script>
<script src="js/html_generator.js"></script>
<script src="js/main.js"></script>

<!-- Leiste zur Auswahl von Leveln -->

<div id="LevelSelectionDiv">
  <!-- Button um zwischen Lern-Sektion und Bastel-Sektion hin und her zu wechseln -->
  <button class="levelButton" onclick="location.href='Lernecke.html'">Lernecke</button>
</div>

<!-- Kompletter Mittelteil der Seite, der komplette grid mit zugehörigen divs -->

<div class="grid-container">
  <div class="item2"><div id="blocklyDiv"></div></div>
  <!-- Hier wird der Preview iframe, der in der update-Funktion im Script-Block befüllt wird in die HTMLPageDiv geladen -->
  <div class="item3"><iframe name="preview" id="HTMLPageDiv"></iframe></div>
  <div class="item4"><div id="HTMLCodeDiv"></div></div>
</div>

<!-- Beginn Skript-Block -->

<script>

 // Einfügen des Blockly-Workspace mit zugehöriger Toolbox in die blocklyDiv

const workspace = Blockly.inject('blocklyDiv', {toolbox: toolbox});

//Laden des vorherigen Zustandes des workspace aus der localStorage des Browsers

 var xml_text = localStorage.getItem("blockly-html-code");
 if (xml_text) {
   var xml = Blockly.Xml.textToDom(xml_text);
   Blockly.Xml.domToWorkspace(xml, workspace);
 }

  // Update-Funktion, die aufgerufen wird, wenn sich im Workspace etwas ändert

  function update(event){

   // Umwandlung des workspace zu HTML-Code via HTMLGenerator
    var code = HtmlGenerator.workspaceToCode(workspace);
    document.getElementById('HTMLCodeDiv').innerText = code;

    // Erstellung des IFrame aus dem erzeugten HTML-Code
    const ifr = document.preview;
    const html = code;
    ifr.document.write(html);
    ifr.document.close();

    // Speichern des Zustandes des workspace in der localStorage des Browsers

    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToText(xml);
    localStorage.setItem("blockly-html-code", xml_text);

  }


  //Aufruf der Updatefunktion, sobald eine Änderung im workspace passiert

workspace.addChangeListener(update);



</script>



</body>

</html>
