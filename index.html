<!doctype html>
<html lang="de">
<head>
  <title>HTML-Tool</title>
  <meta charset="utf-8">
  <style>
    body{
      background-color: #ffbc70;
    }
  </style>
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" type="image/x-icon" href="img/favicon2.png">
  <!-- Laden der benötigten Blockly-Module -->
  <script src="node_modules/blockly/blockly_compressed.js"></script>
  <script src="node_modules/blockly/blocks_compressed.js"></script>
  <!-- Laden der benötigten Blockly-Sprachfiles für deutsche Sprache -->
  <script src="node_modules/blockly/msg/de.js"></script>
</head>
<body id="learningPageBody">
<!-- Laden der benötigten Javascript-Files aus dem Unterverzeichnis js -->
<script src="js/html_blocks.js"></script>
<script src="js/html_generator.js"></script>
<script src="js/main.js"></script>

<!-- Einleitungs-Popup, in dem die ersten Schritte erklärt werden -->

<div id="startPopup">
  <div id="startPopupFläche" class="reveal-modal">
    <button class="closeButton" onclick="closeStartPopup()"><img src="img/redcross.png" alt="schliessen"></button>
    <!-- Inneres des Startpopups in das die einzelnen popupx.html-files geladen werden-->
    <div id="startPopupFrameContainer">
      <iframe name="popupFrame" id="startPopupFrame" width="" height="" src="popup/popup1.html"></iframe>
    </div>
    <div class="popup-container">
      <div class="left-arrow"><button class="arrow-button" onclick="showPreviousPopup()"><img src="img/arrow-left.png" alt="zurück"></button></div>
      <div class="right-arrow"><button class="arrow-button" onclick="showNextPopup()"><img src="img/arrow-right.png" alt="weiter"></button></div>
    </div>
  </div>
</div>

<!-- Levelpopup, in dem die aktuelle Aufgabe erklärt wird -->

<div id="levelPopup">
  <div id="levelPopupFläche" class="reveal-modal">
    <button class="closeButton" onclick="closeLevelPopup()"><img src="img/redcross.png" alt="schliessen"></button>
    <!-- Inneres des Startpopups in das die einzelnen popupx.html-files geladen werden-->
    <div id="levelPopupFrameContainer">
      <iframe name="popupFrame" id="levelPopupFrame" width="" height="" src=""></iframe>
    </div>
    <div class="popup-container">
    </div>
  </div>
</div>

<!-- Kompletter Mittelteil der Seite, der komplette grid mit zugehörigen divs -->

<div class="grid-container">
  <div class="item2">
    <div id="blocklyDiv"></div>
  </div>
  <div class="item5">
    <div id="CodeButtonDiv">

      <button class="button" onclick=showGscheidhaferl()><img src="img/Fragezeichen.png" alt="Fragezeichen" /></button>
      <button class="button" onclick=showHausl()><img src="img/Ausrufezeichen.png" alt="Ausrufezeichen" /></button>
      <button class="button" onclick=nextLevel()><img src="img/Pfeil.png" alt="Pfeil"/></button>

      <label for="aufgabenauswahl">Aufgaben:</label>
      <select name="aufgabenauswahl" id="aufgabenauswahl" onchange="chooseLevel(this.selectedIndex)">
        <option value="1">A1</option>
        <option value="2">A2</option>
        <option value="3">A3</option>
      </select>

    </div>
  </div>
  <!-- Hier wird der Preview iframe, der in der update-Funktion im Script-Block befüllt wird in die HTMLPageDiv geladen -->
  <div class="item3">
    <iframe name="preview" id="HTMLPageDiv"></iframe>
  </div>
  <!-- Iframe oben rechts in dem default-mäßig die Hilfeseite von Frau Gscheidhaferl angezeigt wird-->
  <div class="item4">
    <iframe name="buttonPreview" id="HTMLCodeDiv" src="hilfestellung.html"></iframe>
  </div>
  <!-- Die Buttons neben dem Iframe unten rechts-->
  <div class="item6">
    <div id="switchDiv">
      <button class="button" onclick=showCode()><img src="img/Code.jpg" alt="Code" /></button>
      <button class="button" onclick=switchToPreview()><img src="img/Aufgabe.png" alt="Aufgabe"/></button>
      <button class="button" onclick=showIstZustand()><img src="img/Vorschau.png" alt="Vorschau"/></button>
    </div>
  </div>
  <!-- InfoButton-->
  <div id="infoButtonDiv">
    <button class="button" onclick=showStartPopup()><img src="img/info.png" alt="info"/></button>
  </div>
  <!-- Impressum und Datenschutz Link-->
  <div id="impressumDiv"><a href="Impressum.html">Impressum & Datenschutz</a></div>
</div>
<!-- Beginn Skript-Block -->
<script>
  // Einfügen des Blockly-Workspace mit zugehöriger Toolbox in die blocklyDiv
  const workspace = Blockly.inject('blocklyDiv', {toolbox: toolbox});
  //Laden des vorherigen Zustandes des workspace aus der localStorage des Browsers
  if (localStorage.getItem("blockly-html-code-learning")) {
    var xml_text = localStorage.getItem("blockly-html-code-learning");
    var xml = Blockly.Xml.textToDom(xml_text);
    Blockly.Xml.domToWorkspace(xml, workspace);
  }

  //Popup auf die richtige größe des Bildschirms resizen und anschließend anzeigen
  document.getElementById("startPopupFrame").width=Math.round(window.innerWidth*0.40);
  document.getElementById("startPopupFrame").height=Math.round(window.innerHeight*0.60);
  showStartPopup();
  //Erstellung des Parameters html, der im IFrame ausgegeben wird (wird in update() und switchPreview() benötigt)
  var html;
  //previewCode ist die Vorschau der aktuell erwünschten Seite
  var previewCode;
  //code ist der aktuell aus den Blocks erzeugte Code
  var code;
  //codeFlag zeigt an, was gerade in der HTMLCodeDiv angezeigt werden soll
  var codeFlag;
  //popupFlag zeigt, bei welchem Popup sich der User befindet
  var popupFlag=1;
  //level zeigt an in welchem level sich der User aktuell befindet
  var level;
  //Setzen von previewCode anhand des aktuellen Lernstandes !!!TO DO!!!
  previewCode="<!DOCTYPE HTML>\n" +
    "<html>\n" +
    "<meta charset=\"utf-8\">\n" +
    "<head>\n" +
    "Testschnieselei\n" +
    "</head>\n" +
    "\n" +
    "</html>";

  //Laden des Levels, bei dem sich der User aktuell befindet. Sollte kein gespeichertes Level vorhanden sein wird das Level auf 1 gesetzt

  if (localStorage.getItem("level")){
    level=localStorage.getItem("level");
  }
  else{
    level = 1;
  }

  // Update-Funktion, die aufgerufen wird, wenn sich im Workspace etwas ändert
  function update(event){
    // Umwandlung des workspace zu HTML-Code via HTMLGenerator
    code = HtmlGenerator.workspaceToCode(workspace);
    // Will der User gerade den Code sehen wird dieser aktualisiert in der HTMLCodeDiv
    if(!codeFlag || codeFlag ===0){
      showCode();
    }

    // Speichern des Zustandes des workspace in der localStorage des Browsers
    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToText(xml);
    localStorage.setItem("blockly-html-code-learning", xml_text);
  }
  //Aufruf der Updatefunktion, sobald eine Änderung im workspace passiert
  workspace.addChangeListener(update);
  //function, die den Code im IFrame zwischen der erwünschten Vorschau und dem Ist-Stand des Users wechselt
  function switchToPreview(){
    html=previewCode;
    const previewIfr = document.preview;
    previewIfr.document.write(html);
    previewIfr.document.close();
  }
  //function die den aktuellen Zustand der HTML-Seite anzeigt
  function showIstZustand(){
    const ifr = document.preview;
    html = code;
    ifr.document.write(html);
    ifr.document.close();
  }
  //wird aufgerufen, wenn auf den Code-Knopf gedrückt wird. Zeigt dann den aktuellen aus Blocks erzeugten Code
  function showCode(){
    document.getElementById("switchDiv").src="";
    var htmlCode="<xmp>" + code + "</xmp>";
    const ifr = document.preview;
    ifr.document.write(htmlCode);
    ifr.document.close();
    codeFlag=0;
  }
  //wird aufgerufen, wenn auf den Gscheidhaferl-Knopf gedrückt wird. Zeigt dann die Gscheidhaferl-Page
  function showGscheidhaferl(){
    document.getElementById("HTMLCodeDiv").src="hilfestellung.html";
    codeFlag=1;
  }
  //wird aufgerufen, wenn auf den Hausl-Knopf gedrückt wird. Zeigt dann die zum Level gehörige Hausl-Page
  function showHausl(){
    document.getElementById("HTMLCodeDiv").src="Aufgabenstellung.html";
    codeFlag=2;
  }

  //function die das Einleitungspopup aufruft

  function showStartPopup(){
    document.getElementById("startPopupFrame").src="popup/popup1.html";
    popupFlag=1;
    document.getElementById("startPopup").style.display="block";
  }

  //function die das Einleitungspopup schließt (rotes X)

  function closeStartPopup(){
    document.getElementById("startPopup").style.display="none";
  }

  //function die aufgerufen wird, wenn auf den Nächstes-Level-Button geklickt wird

  function nextLevel(){
    switchLevel(level+1);
  }

  //function die aufgerufen wird, wenn der User im Dropdown das Level ändert

  function chooseLevel(selectedValue){
    switchLevel(selectedValue+1);
  }

  //function die level-Variable, Level-Popup und Aufgabenstellung an das gewünschte Level newLevel anpasst
  //so wie das aktuelle Level in der localStorage speichert. Anschließend wird showLevelPopup aufgerufen, um den User im neuen Level willkommen zu heißen.

  function switchLevel(newLevel){
    level=parseInt(newLevel);
    if(level>3){
      level=3;
    }
    localStorage.setItem("level", level);
    switch(level){
      case 1:
        document.getElementById("levelPopupFrame").src="levelPopup/levelPopup1.html";
        break;
      case 2:
        document.getElementById("levelPopupFrame").src="levelPopup/levelPopup2.html";
        break;
      case 3:
        document.getElementById("levelPopupFrame").src="levelPopup/levelPopup3.html";
        break;
    }
    showLevelPopup();
  }

  //function die das Popup zu Beginn jeden Levels anzeigt

  function showLevelPopup(){
    document.getElementById("levelPopup").style.display="block";
  }

  //function die das Popup zu Beginn jeden Levels schließt

  function closeLevelPopup(){
    document.getElementById("levelPopup").style.display="none";
  }


  //function die im Startpopup wenn auf den Pfeil nach links geklickt wird, das vorherige Popup (popupx.html) als Quelle lädt

  function showPreviousPopup(){
    if (!popupFlag || popupFlag === 1){
    }
    else {
      popupFlag = popupFlag-1
      if(popupFlag===1){
        document.getElementById("startPopupFrame").src="popup/popup1.html"
      }
      if(popupFlag===2){
        document.getElementById("startPopupFrame").src="popup/popup2.html"
      }
      if(popupFlag===3){
        document.getElementById("startPopupFrame").src="popup/popup3.html"
      }
      if(popupFlag===4){
        document.getElementById("startPopupFrame").src="popup/popup4.html"
      }
      if(popupFlag===5){
        document.getElementById("startPopupFrame").src="popup/popup5.html"
      }
    }
  }
  function showNextPopup(){
    if (popupFlag === 6){
    }
    else {
      popupFlag = popupFlag+1
      if(popupFlag===1){
        document.getElementById("popupFrame").src="popup/popup1.html"
      }
      if(popupFlag===2){
        document.getElementById("popupFrame").src="popup/popup2.html"
      }
      if(popupFlag===3){
        document.getElementById("popupFrame").src="popup/popup3.html"
      }
      if(popupFlag===4){
        document.getElementById("popupFrame").src="popup/popup4.html"
      }
      if(popupFlag===5){
        document.getElementById("popupFrame").src="popup/popup5.html"
      }
      if(popupFlag===6){
        document.getElementById("popupFrame").src="popup/popup6.html"
      }
    }
  }


</script>
</body>
</html>


